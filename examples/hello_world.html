<!DOCTYPE html>
<html>
<head>
<style>
  script {
    display: block;
    white-space: pre-wrap;
    border: solid 1px gray;
    background: rgba(0,0,0,.1);
    font-size: 14px;
    margin-bottom: 10px;
    height: 200px;
    overflow: auto;
  }
</style>
</head>
<body>
  <p>Just click the button and you can see the api request and logs in devtools. default rootFd is temp_dir.</p>
  <button id="raw-test">raw test</button>
  <script>
    document.querySelector("#raw-test").addEventListener("click", async () => {
      const origin = 'https://wvwasi.localhost'
      const fs_rights_base =
          1 << 0 | // fd_datasync |
          1 << 1 | // fd_read |
          1 << 2 | // fd_seek |
          1 << 3 | // fd_fdstat_set_flags |
          1 << 4 | // fd_sync |
          1 << 5 | // fd_tell |
          1 << 6 | // fd_write |
          1 << 7 | // fd_advise |
          1 << 8 | // fd_allocate |
          1 << 9 | // path_create_directory |
          1 << 10 | // path_create_file |
          1 << 11 | // path_link_source
          1 << 12 | // path_link_target
          1 << 13 | // path_open
          1 << 14 | // fd_readdir
          1 << 15 | // path_readlink
          1 << 16 | // path_rename_source
          1 << 17 | // path_rename_target
          1 << 18 | // path_filestat_get
          1 << 19 | // path_filestat_set_size
          1 << 20 | // path_filestat_set_times
          1 << 21 | // fd_filestat_get
          1 << 22 | // fd_filestat_set_size
          1 << 23 | // fd_filestat_set_times
          1 << 24 | // path_symlink
          1 << 25 | // path_remove_directory
          1 << 26 | // path_unlink_file
          1 << 27 | // poll_fd_readwrite
          1 << 28 | // sock_shutdown
          1 << 29 // sock_accept TODO use bigInt
      let sharedBuffer, sharedBufferEnd = 0, argc, argvBufSize, environCount, environBufSize, socketFd, rootFd, testTxtFd, testFd

      // align offset
      function align(offset, align) {
        const remainder = offset % align
        return remainder > 0 ? offset + align - remainder : offset;
      }

      function writeStringIntoSharedBuffer(string, sharedBuffer, pathPtr) {
        const path = new TextEncoder().encode(string)
        const pathLen = path.length
        const pathArray = new Uint8Array(sharedBuffer, pathPtr, pathLen*8)
        for(let i = 0; i < pathLen; i++) {
          pathArray[i] = path[i]
        }
        return [pathPtr, pathLen]
      }

      // init
      // sharedBuffer: [] grammar: [[ptr, len], ...]
      try{
        const [[errorCode, index, fd, socket], buffer] = await Promise.all([
          fetch(`${origin}/wasi_snapshot_preview1/init`).then(x => x.json()),
          new Promise(resolve => {
            const sharedBufferReceivedHandler = e => {
              resolve(e.getBuffer())
              window.chrome.webview.removeEventListener("sharedbufferreceived", sharedBufferReceivedHandler);
            }
            window.chrome.webview.addEventListener("sharedbufferreceived", sharedBufferReceivedHandler);
          })
        ])
        wvwasiIndex = index
        rootFd = fd
        socketFd = socket
        sharedBuffer = buffer 
        console.log('init:', {errorCode, wvwasiIndex, rootFd, socketFd, sharedBuffer})
      } catch(e) { console.error(e) }

      // random_get
      // sharedBuffer: [
      //   ...
      //   [bufPtr, bufLen],
      // ]
      try {
        const bufPtr = align(sharedBufferEnd, 4)
        const bufLen = 1024
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/random_get`,
          {
            method: 'POST',
            body: JSON.stringify([bufPtr, bufLen])
          }
        ).then(x => x.json())
        random = new Uint32Array(sharedBuffer, bufPtr, 4)[0];
        console.log("random_get:", {errorCode, bufPtr, bufLen, random})
        sharedBufferEnd = bufPtr + bufLen*1
      } catch(e) { console.error(e) }

      // args_sizes_get
      // sharedBuffer: [
      //   ...
      //   [argcPtr, 4],
      //   [argBufSizePtr, 4],
      // ]
      try {
        const argcPtr = align(sharedBufferEnd, 4)
        const argvBufSizePtr = argcPtr + 4
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/args_sizes_get`,
          {
            method: 'POST',
            body: JSON.stringify([argcPtr, argvBufSizePtr])
          }
        ).then(x => x.json())
        argc = new Uint32Array(sharedBuffer, argcPtr, 4)[0];
        argvBufSize = new Uint32Array(sharedBuffer, argvBufSizePtr, 4)[0]
        console.log("args_sizes_get:", {errorCode, argcPtr, argvBufSizePtr, argc, argvBufSize})
        sharedBufferEnd = argvBufSizePtr + 4
      } catch(e) { console.error(e) }

      // args_get
      // sharedBuffer: [
      //   ...
      //   [argvPtr, Math.max(argc*4, 4)],
      //   [argvBufPtr, Math.max(argvBufSize, 4)],
      // ]
      try {
        const argvPtr = align(sharedBufferEnd, 4)
        const argvBufPtr = argvPtr + Math.max(argc*4, 4)
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/args_get`,
          {
            method: 'POST',
            body: JSON.stringify([argvPtr, argvBufPtr])
          }
        ).then(x => x.json())
        const argv = new Uint32Array(sharedBuffer, argvPtr, argc);
        const argvBuf = new TextDecoder().decode(new Uint8Array(sharedBuffer, argvBufPtr, argvBufSize))
        console.log("args_get:", {errorCode, argvPtr, argvBufPtr, argv, argvBuf})

        sharedBufferEnd = argvBufPtr + Math.max(argvBufSize, 4)
      } catch(e) { console.error(e) }

      // environ_sizes_get
      // sharedBuffer: [
      //   ...
      //   [environCountPtr, 4],
      //   [environBufSizePtr, 4],
      // ]
      try {
        const environCountPtr = align(sharedBufferEnd, 4)
        const environBufSizePtr = environCountPtr + 4
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/environ_sizes_get`,
          {
            method: 'POST',
            body: JSON.stringify([environCountPtr, environBufSizePtr])
          }
        ).then(x => x.json())
        environCount = new Uint32Array(sharedBuffer, environCountPtr, 4)[0];
        environBufSize = new Uint32Array(sharedBuffer, environBufSizePtr, 4)[0]
        console.log("environ_sizes_get:", {errorCode, environCountPtr, environBufSizePtr, environCount, environBufSize})
        sharedBufferEnd = environBufSize + 4
      } catch(e) { console.error(e) }

      // environ_get
      // sharedBuffer: [
      //   ...
      //   [environPtr, Math.max(environCount*4, 4)],
      //   [environBufPtr, Math.max(environBufSize, 4)],
      // ]
      try {
        const environPtr = align(sharedBufferEnd, 4)
        const environBufPtr = environPtr + Math.max(environCount*4, 4)
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/environ_get`,
          {
            method: 'POST',
            body: JSON.stringify([environPtr, environBufPtr])
          }
        ).then(x => x.json())
        const environ = new Uint32Array(sharedBuffer, environPtr, environCount);
        const environBuf = new TextDecoder().decode(new Uint8Array(sharedBuffer, environBufPtr, environBufSize))
        console.log("environ_get:", {errorCode, environPtr, environBufPtr, environ, environBuf})

        sharedBufferEnd = environBufPtr + Math.max(environBufSize, 4)
      } catch(e) { console.error(e) }

      // clock_res_get
      // sharedBuffer: [
      //   ...
      //   [resolutionPtr, 8],
      // ]
      try {
        const clockid = 0 << 0 // realtime
        const resolutionPtr = align(sharedBufferEnd, 8)
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/clock_res_get`,
          {
            method: 'POST',
            body: JSON.stringify([clockid, resolutionPtr])
          }
        ).then(x => x.json())
        const resolution = Number(new BigInt64Array(sharedBuffer, resolutionPtr, 1)[0]);
        console.log("clock_res_get:", {errorCode, clockid, resolution})
        sharedBufferEnd = resolutionPtr + 8
      } catch(e) { console.error(e) }

      // clock_time_get
      // sharedBuffer: [
      //   ...
      //   [timePtr, 4],
      // ]
      try {
        const id = 0 << 0 // realtime
        const precision = 0
        const timePtr = align(sharedBufferEnd, 8)
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/clock_time_get`,
          {
            method: 'POST',
            body: JSON.stringify([id, precision, timePtr])
          }
        ).then(x => x.json())
        const time = new BigInt64Array(sharedBuffer, timePtr, 1)[0];
        console.log("clock_time_get:", {errorCode, id, precision, timePtr, time, timeDate: new Date(Number(time/1000000n))})
        sharedBufferEnd = timePtr + 8
      } catch(e) { console.error(e) }

      // poll_oneoff
      // sharedBuffer: [
      //   ...
      //   [inPtr, 48*8],
      //   [neventsPtr, 8],
      //   [outPtr, 32*8],
      //
      try {
        const inPtr = align(sharedBufferEnd, 4)
        const in_ = new DataView(sharedBuffer, inPtr, 48*8) // https://github.com/WebAssembly/WASI/blob/main/legacy/preview1/docs.md#record-members-16
        const inUserData = 12345678n
        in_.setBigUint64(0, inUserData, true) // in.userdata 8
        const inUTag = 0n // clock https://github.com/WebAssembly/WASI/blob/main/legacy/preview1/docs.md#variant-layout
        in_.setBigUint64(8, inUTag, true) // in.u.tag
        const inUId = 0n // realtime https://github.com/WebAssembly/WASI/blob/main/legacy/preview1/docs.md#clockid
        in_.setBigUint64(16, inUId, true) // in.u.id
        const inUTimeout = 5000000000n // 5s 
        in_.setBigUint64(24, inUTimeout, true) // in.u.timeout
        const inUPrecision = 0n
        in_.setBigUint64(32, inUPrecision, true) // in.u.precision
        const inUFlags = 0n
        in_.setBigUint64(40, inUFlags, true) // in.u.flags
        const neventsPtr = inPtr + 48*8
        const outPtr = neventsPtr + 8
        const nsubscriptions = 1
        const beforeTime = new Date()
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/poll_oneoff`,
          {
            method: 'POST',
            body: JSON.stringify([inPtr, outPtr, nsubscriptions, neventsPtr])
          }
        ).then(x => x.json())
        const afterTime = new Date()
        const nevents = new BigInt64Array(sharedBuffer, neventsPtr, 1)[0];
        console.log("poll_oneoff:", {errorCode, inPtr, outPtr, nsubscriptions, neventsPtr, nevents, beforeTime, afterTime})
        sharedBufferEnd = outPtr + 32*8 // https://github.com/WebAssembly/WASI/blob/main/legacy/preview1/docs.md#record-members-12
      } catch(e) { console.error(e) }

      // fd_prestat_get
      // sharedBuffer: [
      //   [bufPtr, 8],
      // ]
      try {
        const fd = rootFd
        const bufPtr = align(sharedBufferEnd, 8)
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/fd_prestat_get`,
          {
            method: 'POST',
            body: JSON.stringify([fd, bufPtr])
          }
        ).then(x => x.json())
        const prestat = new BigUint64Array(sharedBuffer, bufPtr, 1)[0];
        console.log("fd_prestat_get:", {errorCode, fd, prestat})
        sharedBufferEnd = bufPtr + 8
      } catch(e) { console.error(e) }

      // fd_prestat_dir_name
      // sharedBuffer: [
      //   ...
      //   [path, pathLen],
      // ]
      try {
        const fd = rootFd
        const path = align(sharedBufferEnd, 4)
        const pathLen = 64
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/fd_prestat_dir_name`,
          {
            method: 'POST',
            body: JSON.stringify([fd, path, pathLen])
          }
        ).then(x => x.json())
        const dirName = new TextDecoder().decode(new Uint8Array(sharedBuffer, path, pathLen))
        console.log("fd_prestat_dir_name:", {errorCode, fd, path, pathLen, dirName})
        sharedBufferEnd = path + pathLen
      } catch(e) { console.error(e) }

      // fd_fdstat_get
      // sharedBuffer: [
      //   ...
      //   [fdstatPtr, fdstatLen],
      // ]
      try {
        const fd = rootFd
        const fdstatPtr = align(sharedBufferEnd, 8)
        const fdstatLen = 24
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/fd_fdstat_get`,
          {
            method: 'POST',
            body: JSON.stringify([fd, fdstatPtr])
          }
        ).then(x => x.json())
        const fdstat = new BigUint64Array(sharedBuffer, fdstatPtr, fdstatLen/8);
        const filetype = new Uint8Array(sharedBuffer, fdstatPtr, 1)[0]
        const flags = new Uint8Array(sharedBuffer, fdstatPtr + 2, 1)[0]
        console.log("fd_fdstat_get:", {errorCode, fd, fdstatPtr, fdstatLen, fdstat, filetype, flags})
        sharedBufferEnd = fdstatPtr + fdstatLen
      } catch(e) { console.error(e) }

      // path_open
      // sharedBuffer: [
      //   ...
      //   [pathPtr, pathLen],
      //   [fdPtr, 4],
      // ]
      try {
        const [pathPtr, pathLen] = writeStringIntoSharedBuffer(
          "test.txt",
          sharedBuffer,
          align(sharedBufferEnd, 4)
        )
        const fdPtr = align(pathPtr + pathLen, 4) // align to 4
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/path_open`,
          {
            method: 'POST',
            body: JSON.stringify([
              rootFd, // dirfd,
              1 << 0, // dirflags Lookupflags::SYMLINK_FOLLOW ,
              pathPtr,
              pathLen,
              1 << 0, // o_flags Oflags::CREAT,
              fs_rights_base,
              0, // fs_rights_inheriting,
              0, // fdflags,
              fdPtr
            ])
          }
        ).then(x => x.json())
        const fd = new Uint32Array(sharedBuffer, fdPtr, 4)[0]
        console.log('path_open:', {errorCode, fd, fs_rights_base})
        sharedBufferEnd = fdPtr + 4
        testTxtFd = fd
      } catch(e) { console.error(e) }

      // fd_advise
      try {
        const fd = testTxtFd
        const offset = 0
        const len = 64
        const advice = 0 // normal
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/fd_advise`,
          {
            method: 'POST',
            body: JSON.stringify([fd, offset, len, advice])
          }
        ).then(x => x.json())
        console.log("fd_advise:", {errorCode, fd, offset, len, advice})
      } catch(e) { console.error(e) }

      // fd_allocate
      try {
        const fd = testTxtFd
        const offset = 0
        const len = 64
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/fd_allocate`,
          {
            method: 'POST',
            body: JSON.stringify([fd, offset, len])
          }
        ).then(x => x.json())
        console.log("fd_allocate:", {errorCode, fd, offset, len})
      } catch(e) { console.error(e) }

      // fd_filestat_set_size
      try {
        const fd = testTxtFd
        const size = 64
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/fd_filestat_set_size`,
          {
            method: 'POST',
            body: JSON.stringify([fd, size])
          }
        ).then(x => x.json())
        console.log("fd_filestat_set_size:", {errorCode, fd, size})
      } catch(e) { console.error(e) }

      // fd_filestat_set_times
      try {
        const fd = testTxtFd
        const atim = new Date().getTime()
        const mtim = new Date().getTime()
        const fst_flags = 
          1 << 0 | // atim
          1 << 2 // mtim
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/fd_filestat_set_times`,
          {
            method: 'POST',
            body: JSON.stringify([fd, atim, mtim, fst_flags])
          }
        ).then(x => x.json())
        console.log("fd_filestat_set_times:", {errorCode, fd, atim, mtim, fst_flags})
      } catch(e) { console.error(e) }

      // fd_fdstat_set_flags
      try {
        const fd = testTxtFd
        const flags = 1 << 0 // append
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/fd_fdstat_set_flags`,
          {
            method: 'POST',
            body: JSON.stringify([fd, flags])
          }
        ).then(x => x.json())
        console.log("fd_fdstat_set_flags:", {errorCode, fd, flags})
      } catch(e) { console.error(e) }

      // fd_fdstat_set_rights
      try {
        const fd = testTxtFd
        const fs_rights_inheriting = fs_rights_base 
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/fd_fdstat_set_rights`,
          {
            method: 'POST',
            body: JSON.stringify([fd, fs_rights_base, fs_rights_inheriting])
          }
        ).then(x => x.json())
        console.log("fd_fdstat_set_rights:", {errorCode, fd, fs_rights_base, fs_rights_inheriting})
      } catch(e) { console.error(e) }

      // fd_filestat_get
      // sharedBuffer: [
      //   ...
      //   [filestatPtr, filestatLen],
      try {
        const fd = testTxtFd
        const filestatPtr = align(sharedBufferEnd, 8)
        const filestatLen = 64
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/fd_filestat_get`,
          {
            method: 'POST',
            body: JSON.stringify([fd, filestatPtr])
          }
        ).then(x => x.json())
        const filestat = new BigUint64Array(sharedBuffer, filestatPtr, filestatLen/8);
        const filetype = new Uint8Array(sharedBuffer, filestatPtr + 2*8, 1)[0]
        console.log("fd_filestat_get:", {errorCode, fd, filestatPtr, filestatLen, filestat, filetype})
        sharedBufferEnd = filestatPtr + filestatLen
      } catch(e) { console.error(e) }

      // fd_fdstat_get
      // sharedBuffer: [
      //   ...
      //   [fdstatPtr, fdstatLen],
      // ]
      try {
        const fd = testTxtFd
        const fdstatPtr = align(sharedBufferEnd, 8)
        const fdstatLen = 24
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/fd_fdstat_get`,
          {
            method: 'POST',
            body: JSON.stringify([fd, fdstatPtr])
          }
        ).then(x => x.json())
        const fdstat = new BigUint64Array(sharedBuffer, fdstatPtr, fdstatLen/8);
        const filetype = new Uint8Array(sharedBuffer, fdstatPtr, 1)[0]
        const flags = new Uint8Array(sharedBuffer, fdstatPtr + 2, 1)[0]
        console.log("fd_fdstat_get:", {errorCode, fd, fdstatPtr, fdstatLen, fdstat, filetype, flags})
        sharedBufferEnd = fdstatPtr + fdstatLen
      } catch(e) { console.error(e) }

      // fd_write
      // sharedBuffer: [
      //   ...
      //   [iovsPtr, iovsLen*8],
      //   [nwrittenPtr, 4],
      //   [iovsBufPtr, written.length],
      // ]
      try {
        // https://github.com/WebAssembly/WASI/blob/main/legacy/preview1/docs.md#-iovec_array-listiovec Size: 8 Alignment: 4
        const iovsPtr = align(sharedBufferEnd, 4) // align to 4
        const iovsLen = 1
        const writtenText = "I'm wvwasi written!"
        const written = new TextEncoder().encode(writtenText)
        const nwrittenPtr = align(iovsPtr + iovsLen*8, 4)
        const iovsBufPtr = nwrittenPtr + 4
        const iovs = new DataView(sharedBuffer, iovsPtr, iovsLen*8)
        iovs.setInt32(0, iovsBufPtr, true) // iovs.buf_ptr
        iovs.setInt32(4, written.length, true) // iovs.buf_len
        const pathArray = new Uint8Array(sharedBuffer, iovsBufPtr, written.length)
        for(let i = 0, l = written.length; i < l; i++) {
          pathArray[i] = written[i]
        }
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/fd_write`,
          {
            method: 'POST',
            body: JSON.stringify([testTxtFd, iovsPtr, iovsLen, nwrittenPtr])
          }
        ).then(x => x.json())
        const nwritten = new Int32Array(sharedBuffer, nwrittenPtr, 1)[0];
        console.log("fd_write:", {errorCode, nwritten, writtenText, written})
        sharedBufferEnd = iovsBufPtr + written.length
      } catch(e) { console.error(e) }

      // fd_renumber
      try {
        const fd = testTxtFd
        const to = 5
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/fd_renumber`,
          {
            method: 'POST',
            body: JSON.stringify([fd, to])
          }
        ).then(x => x.json())
        console.log("fd_renumber:", {errorCode, fd, to})
        testTxtFd = to
      } catch(e) { console.error(e) }

      // fd_datasync
      try {
        const fd = testTxtFd
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/fd_datasync`,
          {
            method: 'POST',
            body: JSON.stringify([fd])
          }
        ).then(x => x.json())
        console.log("fd_datasync:", {errorCode, fd})
      } catch(e) { console.error(e) }

      // fd_sync
      try {
        const fd = testTxtFd
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/fd_sync`,
          {
            method: 'POST',
            body: JSON.stringify([fd])
          }
        ).then(x => x.json())
        console.log("fd_sync:", {errorCode, fd})
      } catch(e) { console.error(e) }

      // fd_tell
      // sharedBuffer: [
      //   ...
      //   [offsetPtr, 8],
      // ]
      try {
        const fd = testTxtFd
        const offsetPtr = align(sharedBufferEnd, 8)
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/fd_tell`,
          {
            method: 'POST',
            body: JSON.stringify([fd, offsetPtr])
          }
        ).then(x => x.json())
        const offset = new BigUint64Array(sharedBuffer, offsetPtr, 1)[0];
        console.log("fd_tell:", {errorCode, fd, offset})
        sharedBufferEnd = offsetPtr + 8
      } catch(e) { console.error(e) }

      // fd_pwrite
      // sharedBuffer: [
      //   ...
      //   [iovsPtr, iovsLen*8],
      //   [nwittenPtr, 4],
      //   [iovsBufPtr, written.length],
      // ]
      try {
        const iovsPtr = align(sharedBufferEnd, 4) // align to 4
        const iovsLen = 1
        const writtenText = " And this is from fd_pwrite."
        const written = new TextEncoder().encode(writtenText)
        const nwrittenPtr = align(iovsPtr + iovsLen*8, 4)
        const iovsBufPtr = nwrittenPtr + 4
        const iovs = new DataView(sharedBuffer, iovsPtr, iovsLen*8)
        iovs.setInt32(0, iovsBufPtr, true) // iovs.buf_ptr
        iovs.setInt32(4, written.length, true) // iovs.buf_len
        const pathArray = new Uint8Array(sharedBuffer, iovsBufPtr, written.length)
        for(let i = 0, l = written.length; i < l; i++) {
          pathArray[i] = written[i]
        }
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/fd_pwrite`,
          {
            method: 'POST',
            body: JSON.stringify([
              testTxtFd,
              iovsPtr,
              iovsLen,
              19, // offset
              nwrittenPtr
            ])
          }
        ).then(x => x.json())
        const nwritten = new Int32Array(sharedBuffer, nwrittenPtr, 1)[0];
        console.log("fd_pwrite:", {errorCode, nwritten, writtenText, written})
        sharedBufferEnd = iovsBufPtr + written.length
      } catch(e) { console.error(e) }

      // fd_pread
      // sharedBuffer: [
      //   ...
      //   [iovsPtr, iovsLen*8],
      //   [nreadPtr, 4],
      //   [iovsBufPtr, 128],
      // ]
      try {
        // https://github.com/WebAssembly/WASI/blob/main/legacy/preview1/docs.md#-iovec_array-listiovec Size: 8 Alignment: 4
        const iovsPtr = align(sharedBufferEnd, 4) // align to 4 https://github.com/WebAssembly/WASI/blob/main/legacy/preview1/docs.md#-iovec-record
        const iovsLen = 1
        const nreadPtr = align(iovsPtr + iovsLen*8, 4)
        const iovsBufPtr = nreadPtr + 4
        const iovs = new DataView(sharedBuffer, iovsPtr, iovsLen*8)
        iovs.setInt32(0, iovsBufPtr, true) // iovs.buf_ptr
        iovs.setInt32(4, 128, true) // iovs.buf_len
        const offset = 4
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/fd_pread`,
          {
            method: 'POST',
            body: JSON.stringify([
              testTxtFd,
              iovsPtr,
              iovsLen,
              offset,
              nreadPtr
            ])
          }
        ).then(x => x.json())
        const nread = new Int32Array(sharedBuffer, nreadPtr, 1)[0]
        const read = new TextDecoder().decode(new Uint8Array(sharedBuffer, iovsBufPtr, nread))
        console.log("fd_pread:", {errorCode, offset, nread, read})
        sharedBufferEnd = iovsBufPtr + 128
      } catch(e) { console.error(e) }

      // fd_seek
      // sharedBuffer: [
      //   ...
      //   [newoffsetPtr, 8]
      // ]
      try {
        const newoffsetPtr = align(sharedBufferEnd, 8) // align to 8 https://github.com/WebAssembly/WASI/blob/main/legacy/preview1/docs.md#-filesize-u64
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/fd_seek`,
          {
            method: 'POST',
            body: JSON.stringify([
              testTxtFd,
              0, // offset
              0, // whence set, Seek relative to start-of-file.
              newoffsetPtr
            ])
          }
        ).then(x => x.json())
        const newoffset = new BigUint64Array(sharedBuffer, newoffsetPtr, 1)[0];
        console.log("fd_seek:", {errorCode, newoffset})
        sharedBufferEnd = newoffsetPtr + 8
      } catch(e) { console.error(e) }

      // fd_read
      // sharedBuffer: [
      //   ...
      //   [iovsPtr, iovsLen*8],
      //   [nreadPtr, 4],
      //   [iovsBufPtr, 128],
      // ]
      try {
        // https://github.com/WebAssembly/WASI/blob/main/legacy/preview1/docs.md#-iovec_array-listiovec Size: 8 Alignment: 4
        const iovsPtr = align(sharedBufferEnd, 4) // align to 4
        const iovsLen = 1
        const nreadPtr = align(iovsPtr + iovsLen*8, 4)
        const iovsBufPtr = nreadPtr + 4
        const iovs = new DataView(sharedBuffer, iovsPtr, iovsLen*8)
        iovs.setInt32(0, iovsBufPtr, true) // iovs.buf_ptr
        iovs.setInt32(4, 128, true) // iovs.buf_len
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/fd_read`,
          {
            method: 'POST',
            body: JSON.stringify([testTxtFd, iovsPtr, iovsLen, nreadPtr])
          }
        ).then(x => x.json())
        const nread = new Int32Array(sharedBuffer, nreadPtr, 1)[0];
        const read = new TextDecoder().decode(new Uint8Array(sharedBuffer, iovsBufPtr, nread))
        console.log("fd_read:", {errorCode, nread, read})
        sharedBufferEnd = iovsBufPtr + 128
      } catch(e) { console.error(e) }
        
      // path_create_directory
      // sharedBuffer: [
      //   ...
      //   [pathPtr, pathLen],
      // ]
      try {
        const fd = rootFd
        const [pathPtr, pathLen] = writeStringIntoSharedBuffer(
          "test",
          sharedBuffer,
          align(sharedBufferEnd, 4)
        )
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/path_create_directory`,
          {
            method: 'POST',
            body: JSON.stringify([
              fd,
              pathPtr,
              pathLen,
            ])
          }
        ).then(x => x.json())
        console.log("path_create_directory:", {errorCode, pathPtr, pathLen})
        sharedBufferEnd = pathPtr + pathLen
      } catch(e) { console.error(e) }

      // Only NTFS supports symbolic links in Windows, and only with administrator privileges.
      // path_symlink
      // sharedBuffer: [
      //   ...
      //   [oldPathPtr, oldPathLen],
      //   [newPathPtr, newPathLen],
      // ]
      try {
        const [oldPathPtr, oldPathLen] = writeStringIntoSharedBuffer(
          "test.txt",
          sharedBuffer,
          align(sharedBufferEnd, 4)
        )
        const fd = rootFd
        const [newPathPtr, newPathLen] = writeStringIntoSharedBuffer(
          "test-symlink.txt",
          sharedBuffer,
          align(oldPathPtr + oldPathLen, 4)
        )
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/path_symlink`,
          {
            method: 'POST',
            body: JSON.stringify([
              oldPathPtr,
              oldPathLen,
              fd,
              newPathPtr,
              newPathLen,
            ])
          }
        ).then(x => x.json())
        console.log('path_symlink:', {errorCode, oldPathPtr, oldPathLen, fd, newPathPtr, newPathLen})
        sharedBufferEnd = newPathPtr + newPathLen
      } catch(e) { console.error(e) }
        
      // path_link
      // sharedBuffer: [
      //   ...
      //   [oldPathPtr, oldPathLen],
      //   [newPathPtr, newPathLen],
      // ]
      try {
        const [oldPathPtr, oldPathLen] = writeStringIntoSharedBuffer(
          "test.txt",
          sharedBuffer,
          align(sharedBufferEnd, 4)
        )
        const oldFd = rootFd
        const oldFlags = 0 << 0 // dirflags
        const newFd = rootFd
        const [newPathPtr, newPathLen] = writeStringIntoSharedBuffer(
          "test-link.txt",
          sharedBuffer,
          align(oldPathPtr + oldPathLen, 4)
        )
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/path_link`,
          {
            method: 'POST',
            body: JSON.stringify([
              oldFd,
              oldFlags,
              oldPathPtr,
              oldPathLen,
              newFd,
              newPathPtr,
              newPathLen,
            ])
          }
        ).then(x => x.json())
        console.log('path_link:', {errorCode, oldFd, oldFlags, oldPathPtr, oldPathLen, newFd, newPathPtr, newPathLen})
        sharedBufferEnd = newPathPtr + newPathLen
      } catch(e) { console.error(e) }

      // path_rename
      // sharedBuffer: [
      //   ...
      //   [oldPathPtr, oldPathLen],
      //   [newPathPtr, newPathLen],
      // ]
      try {
        const [oldPathPtr, oldPathLen] = writeStringIntoSharedBuffer(
          "test-link.txt",
          sharedBuffer,
          align(sharedBufferEnd, 4)
        )
        const fd = rootFd
        const newFd = rootFd
        const [newPathPtr, newPathLen] = writeStringIntoSharedBuffer(
          "test-link-rename.txt",
          sharedBuffer,
          align(oldPathPtr + oldPathLen, 4)
        )
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/path_rename`,
          {
            method: 'POST',
            body: JSON.stringify([
              fd,
              oldPathPtr,
              oldPathLen,
              newFd,
              newPathPtr,
              newPathLen,
            ])
          }
        ).then(x => x.json())
        console.log('path_rename:', {errorCode, fd, oldPathPtr, oldPathLen, newFd, newPathPtr, newPathLen})
        sharedBufferEnd = newPathPtr + newPathLen
      } catch(e) { console.error(e) }

      // path_filestat_get
      // sharedBuffer: [
      //   ...
      //   [pathPtr, pathLen],
      //   [bufPtr, bufLen],
      // ]
      try {
        const fd = rootFd
        const flags = 0 << 0 // dirflags
        const [pathPtr, pathLen] = writeStringIntoSharedBuffer(
          "test-link-rename.txt",
          sharedBuffer,
          align(sharedBufferEnd, 4)
        )
        const bufPtr = align(sharedBufferEnd, 8)
        const bufLen = 64
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/path_filestat_get`,
          {
            method: 'POST',
            body: JSON.stringify([
              fd,
              flags,
              pathPtr,
              pathLen,
              bufPtr,
            ])
          }
        ).then(x => x.json())
        const filestat = new BigUint64Array(sharedBuffer, bufPtr, bufLen/8);
        const filetype = new Uint8Array(sharedBuffer, bufPtr + 2*8, 1)[0]
        console.log("path_filestat_get:", {errorCode, fd, flags, pathPtr, pathLen, bufPtr, bufLen, filestat, filetype})
        sharedBufferEnd = bufPtr + bufLen
      } catch(e) { console.error(e) }

      // path_filestat_set_times
      try {
        const fd = rootFd
        const flags = 0 << 0
        const [pathPtr, pathLen] = writeStringIntoSharedBuffer(
          "test-link-rename.txt",
          sharedBuffer,
          align(sharedBufferEnd, 4)
        )
        const atim = new Date().getTime()
        const mtim = new Date().getTime()
        const fst_flags = 
          1 << 0 | // atim
          1 << 2 // mtim
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/path_filestat_set_times`,
          {
            method: 'POST',
            body: JSON.stringify([
              fd,
              flags,
              pathPtr,
              pathLen,
              atim,
              mtim,
              fst_flags
            ])
          }
        ).then(x => x.json())
        console.log("path_filestat_set_times:", {errorCode, fd, atim, mtim, fst_flags})
      } catch(e) { console.error(e) }

      // fd_readdir
      // sharedBuffer: [
      //   ...
      //   [bufusedPtr, 4],
      //   [buf, bufused],
      // ]
      try {
        const fd = rootFd
        const bufusedPtr = align(sharedBufferEnd, 4)
        const buf = align(bufusedPtr + 4, 4)
        const bufLen = sharedBuffer.byteLength - buf
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/fd_readdir`,
          {
            method: 'POST',
            body: JSON.stringify([
              fd,
              buf,
              bufLen,
              0, // cookie
              bufusedPtr,
            ])
          }
        ).then(x => x.json())
        const bufused = new Int32Array(sharedBuffer, bufusedPtr, 1)[0];
        console.log('fd_readdir:', {errorCode, fd, bufusedPtr, buf, bufused})
        sharedBufferEnd = buf + bufused
      } catch(e) { console.error(e) }
        
      // path_unlink_file
      // sharedBuffer: [
      //   ...
      //   [pathPtr, pathLen],
      // ]
      try {
        const fd = rootFd
        const [pathPtr, pathLen] = writeStringIntoSharedBuffer(
          "test-link-rename.txt",
          sharedBuffer,
          align(sharedBufferEnd, 4)
        )
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/path_unlink_file`,
          {
            method: 'POST',
            body: JSON.stringify([
              fd,
              pathPtr,
              pathLen
            ])
          }
        ).then(x => x.json())
        console.log("path_unlink_file:", {errorCode, fd, pathPtr, pathLen})
        sharedBufferEnd = pathPtr + pathLen
      } catch(e) { console.error(e) }

      // path_remove_directory
      // sharedBuffer: [
      //   ...
      //   [pathPtr, pathLen],
      // ]
      try {
        const fd = rootFd
        const [pathPtr, pathLen] = writeStringIntoSharedBuffer(
          "test",
          sharedBuffer,
          align(sharedBufferEnd, 4)
        )
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/path_remove_directory`,
          {
            method: 'POST',
            body: JSON.stringify([
              fd,
              pathPtr,
              pathLen,
            ])
          }
        ).then(x => x.json())
        console.log("path_remove_directory:", {errorCode, fd, pathPtr, pathLen})
        sharedBufferEnd = pathPtr + pathLen
      } catch(e) { console.error(e) }

      // fd_close
      try {
        const fd = testTxtFd
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/fd_close`,
          {
            method: 'POST',
            body: JSON.stringify([fd])
          }
        ).then(x => x.json())
        console.log("fd_close:", {errorCode, fd})
      } catch(e) { console.error(e) }

      // path_unlink_file
      // sharedBuffer: [
      //   ...
      //   [pathPtr, pathLen],
      // ]
      try {
        const fd = rootFd
        const [pathPtr, pathLen] = writeStringIntoSharedBuffer(
          "test.txt",
          sharedBuffer,
          align(sharedBufferEnd, 4)
        )
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/path_unlink_file`,
          {
            method: 'POST',
            body: JSON.stringify([
              fd,
              pathPtr,
              pathLen
            ])
          }
        ).then(x => x.json())
        console.log("path_unlink_file:", {errorCode, fd, pathPtr, pathLen})
        sharedBufferEnd = pathPtr + pathLen
      } catch(e) { console.error(e) }

      // Only NTFS supports symbolic links in Windows, and only with administrator privileges.
      // path_readlink
      // sharedBuffer: [
      //   ...
      //   [pathPtr, pathLen],
      //   [bufusedPtr, 4],
      //   [buf, bufused],
      // ]
      try {
        const fd = rootFd
        const [pathPtr, pathLen] = writeStringIntoSharedBuffer(
          "test-symlink.txt",
          sharedBuffer,
          align(sharedBufferEnd, 4)
        )
        const bufusedPtr = align(pathPtr + pathLen, 4)
        const buf = align(bufusedPtr + 4, 4)
        const bufLen = sharedBuffer.byteLength - buf
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/path_readlink`,
          {
            method: 'POST',
            body: JSON.stringify([
              fd,
              pathPtr,
              pathLen,
              buf,
              bufLen,
              bufusedPtr,
            ])
          }
        ).then(x => x.json())
        const bufused = new Int32Array(sharedBuffer, bufusedPtr, 1)[0];
        console.log("path_readlink:", {errorCode, fd, pathPtr, pathLen, buf, bufLen, bufusedPtr, bufused})
        sharedBufferEnd = buf + bufused 
      } catch(e) { console.error(e) }

      // sock_accept telnet 127.0.0.1 9999 | echo hi i am telnet
      // sharedBuffer: [
      //   ...
      //   [resultFdPtr, 4],
      // ]
      try {
        const fd = socketFd
        const flags = 1 << 2 // nonblock
        const resultFdPtr = align(sharedBufferEnd, 4)
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/sock_accept`,
          {
            method: 'POST',
            body: JSON.stringify([
              fd,
              flags,
              resultFdPtr,
            ])
          }
        ).then(x => x.json())
        const resultFd = new Int32Array(sharedBuffer, resultFdPtr, 1)[0];
        socketFd = resultFd
        console.log("sock_accept:", {errorCode, fd, flags, resultFdPtr, resultFd})
        sharedBufferEnd = resultFdPtr + 4
      } catch(e) { console.error(e) }

      // sock_recv
      // sharedBuffer: [
      //   ...
      //   [riDataPtr, riDataLen*8],
      //   [sizePtr, 4],
      //   [roflagsPtr, 4],
      //   [iovsBufPtr, iovsBufLen],
      // ]
      try {
        const fd = socketFd
        const riDataPtr = align(sharedBufferEnd, 4) // align to 4
        const riDataLen = 1
        const riFlags = 0 << 0
        const sizePtr = align(riDataPtr + riDataLen*8, 4)
        const roflagsPtr = sizePtr + 4
        const iovsBufPtr = roflagsPtr + 4
        const iovsBufLen = 128
        const iovs = new DataView(sharedBuffer, riDataPtr, riDataLen*8)
        iovs.setInt32(0, iovsBufPtr, true) // iovs.buf_ptr
        iovs.setInt32(4, iovsBufLen, true) // iovs.buf_len
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/sock_recv`,
          {
            method: 'POST',
            body: JSON.stringify([fd, riDataPtr, riDataLen, riFlags, sizePtr, roflagsPtr])
          }
        ).then(x => x.json())
        const size = new Int32Array(sharedBuffer, sizePtr, 1)[0];
        const roflags = new Int32Array(sharedBuffer, roflagsPtr, 1)[0];
        console.log("sock_recv:", {errorCode, riDataPtr, riDataLen, riFlags, sizePtr, roflagsPtr, size, roflags})
        sharedBufferEnd = iovsBufPtr + iovsBufLen
      } catch(e) { console.error(e) }

      // sock_send
      // sharedBuffer: [
      //   ...
      //   [siDataPtr, siDataLen*8],
      //   [sizePtr, 4],
      //   [iovsBufPtr, iovsBufLen],
      // ]
      try {
        const fd = socketFd
        const siDataPtr = align(sharedBufferEnd, 4) // align to 4
        const siDataLen = 1
        const sizePtr = align(siDataPtr + siDataLen*8, 4)
        const iovsBufPtr = sizePtr + 4
        const send = new TextEncoder().encode("I'm wvwasi sock_send!")
        const iovsBufLen = send.length
        const iovs = new DataView(sharedBuffer, siDataPtr, siDataLen*8)
        iovs.setInt32(0, iovsBufPtr, true) // iovs.buf_ptr
        iovs.setInt32(4, iovsBufLen, true) // iovs.buf_len
        const pathArray = new Uint8Array(sharedBuffer, iovsBufPtr, iovsBufLen)
        for(let i = 0, l = iovsBufLen; i < l; i++) {
          pathArray[i] = send[i]
        }
        const siFlags = 0 << 0
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/sock_send`,
          {
            method: 'POST',
            body: JSON.stringify([fd, siDataPtr, siDataLen, siFlags, sizePtr])
          }
        ).then(x => x.json())
        const size = new Int32Array(sharedBuffer, sizePtr, 1)[0];
        console.log("si_flags:", {errorCode, siDataPtr, siDataLen, siFlags, sizePtr, size})
        sharedBufferEnd = iovsBufPtr + iovsBufLen
      } catch(e) { console.error(e) }

      // sock_shutdown
      // sharedBuffer: [
      //   ...
      // ]
      try {
        const fd = socketFd
        const how = 
          1 << 0 | // read
          1 << 1 // write
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/sock_shutdown`,
          {
            method: 'POST',
            body: JSON.stringify([fd, how])
          }
        ).then(x => x.json())
        console.log("sock_shutdown:", {errorCode, fd, how})
      } catch(e) { console.error(e) }

      // path_unlink_file
      // sharedBuffer: [
      //   ...
      //   [pathPtr, pathLen],
      // ]
      try {
        const fd = rootFd
        const [pathPtr, pathLen] = writeStringIntoSharedBuffer(
          "test-symlink.txt",
          sharedBuffer,
          align(sharedBufferEnd, 4)
        )
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/path_unlink_file`,
          {
            method: 'POST',
            body: JSON.stringify([
              fd,
              pathPtr,
              pathLen
            ])
          }
        ).then(x => x.json())
        console.log("path_unlink_file:", {errorCode, fd, pathPtr, pathLen})
        sharedBufferEnd = pathPtr + pathLen
      } catch(e) { console.error(e) }

      // sched_yield
      try {
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/sched_yield`,
          {
            method: 'POST',
            body: JSON.stringify([
            ])
          }
        ).then(x => x.json())
        console.log("sched_yield:", {errorCode})
      } catch(e) { console.error(e) }

      // proc_raise
      try {
        const sig = 0
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/proc_raise`,
          {
            method: 'POST',
            body: JSON.stringify([
              sig,
            ])
          }
        ).then(x => x.json())
        console.log("proc_raise:", {errorCode, sig})
      } catch(e) { console.error(e) }

      // proc_exit
      try {
        const rval = 0
        const [errorCode] = await fetch(
          `${origin}/${wvwasiIndex}/wasi_snapshot_preview1/proc_exit`,
          {
            method: 'POST',
            body: JSON.stringify([
              rval,
            ])
          }
        ).then(x => x.json())
        console.log("proc_exit:", {errorCode, rval })
      } catch(e) { console.error(e) }
    })
  </script>

  <button id="wvwasi-test">WvWasi test</button>
  <script>
    document.querySelector("#wvwasi-test").addEventListener("click", async () => {
      try {
        const wvwasi = new window.WvWasi()
        console.log(wvwasi)

        console.log(await wvwasi.wasiSnapshotPreview1.init())

        const rootFd = wvwasi.wasiSnapshotPreview1.rootFd
        const sharedBuffer = wvwasi.wasiSnapshotPreview1.sharedBuffer

        console.log(await preview1.fd_readdir(
          rootFd,
          0x4,
          sharedBuffer.byteLength,
          0,
          0x0
        ))

        console.log(await preview1.path_remove_directory(
          rootFd,
          "test",
        ))

        console.log(await wvwasi.path_unlink_file(
          rootFd,
          "test",
        ))
      } catch(e) {
        console.error(e)
      }
    })
  </script>
</body>
</html>